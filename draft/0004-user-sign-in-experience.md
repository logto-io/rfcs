---
Start date: 2024-05-24
Author(s): [simeng-li]
Revision: 1
---

# Experience APIs

## 1. Abstract

Sign-in experience is the user authentication process in Logto. It encompasses both the user interface and a set of APIs. These APIs enable anonymous end-users to interact with Logto for identity verification and profile fulfillment, thereby completing the authentication process.

## 2. Motivation

In Logto, we support a variety of modern authentication methods such as password, social login, and multi-factor authentication (MFA). Developers may require a flexible and customizable sign-in experience to meet their specific use cases.

The current version of Experience API (internally called interaction API) in Logto are neither well-documented nor publicly available for the developers. This document aims to provide a comprehensive overview of the authentication model in Logto and introduce a new set of APIs that allow developers to build a customized sign-in experience for their users.

## 3. Introduction

### 3.1 Terminology

- **Sign-in experience**: A user's experience when interacting with Logto. Including the front-end user interface and the back-end API calls.
- **Sign-in experience settings**: The configuration settings that define the behavior of the sign-in experience, including the required identifiers, verification methods, profile data, and MFA settings. Developers can customize the sign-in experience settings to meet their specific requirements.
- **Experience API**: A set of APIs that allow end-users to interact with the Logto for identity verification and profile management.
- **Experience app**: The front-end application that provides the user interface for sign-in experience.
- **Interaction**: A short-lived session that starts when a user initiates the sign-in experience. By default, it has an expiration time of one hour.
- **Social identity**: The data used to identify a user within a social identity provider, such as Google.
- **SSO (Single sign-on) identity**: The data used to identify a user within an identity provider that is configured as an enterprise SSO connector in Logto.
- **Identifier**: A piece of information used to identify a user in Logto. It could be a username, email, phone number, social identity, SSO identity, among others. Each identifier should be unique within its type.
- **Verification code**: A one-time code sent to the user's email or phone number for identity verification.
- **Verification record**: A group of data can be used to verify a user's identity by such as password, verification code, social identity, etc.
- **Verification ID**: A unique identifier for a verification record. It's a random string generated by the Logto server when a verification record is initiated. Users need to provide the verification ID along with additional security information to verify their identity. The verification ID can also be used to track the status of the verification record within the interaction.
- **Multi-factor authentication (MFA)**: A security process that requires more than one verification factor to complete the interaction. It can be used as an additional security check during the sign-in experience.
- **First party application**: A application that is built and managed by the same company that uses Logto for user authentication.
- **Third party application**: A application that is owned and managed by a different company that uses Logto as a external identity provider. E.g. A external application that uses Logto as a enterprise SSO provider.

### 3.2 User experience

The user sign-in experience in Logto consists of the following key steps:

1. **Sign-in experience initiation**: When the client application sends an authentication request to Logto, the user is redirected to Logto's experience app, initiating a new interaction for the authentication process.
2. **Identification**: The user must provide an identifier to Logto, such as a username, email address, phone number, social identity, or SSO identity. This identifier is used to recognize the user during the interaction.
3. **Verification**: The process to verify a user's identity by requesting additional security information. This can be a password, a one-time code, a passkey, etc. Upon the security settings, multiple verification methods can be used.
4. **Profile fulfillment**: : During the interaction, the user may be prompted to complete their profile and MFA settings. This can be necessary for user registration or mandatory updates for existing users' profiles and MFA settings.
5. **Authentication**: Once the user has completed all the necessary steps, they can submit the interaction to get authenticated by Logto. All the user's profile and MFA settings updates will be saved to the user database.
6. **Consent**: Users may need to grant consent for specific actions upon the requested authorization details. This could involve sharing personal information, allowing access for their organization, or granting permissions to specific resources. For first-party applications, consent is implicit and handled automatically by Logto once user get authenticated. For third-party applications, consent is explicit, and the user will be prompted to grant the necessary permissions after a successful interaction submission.
7. **Authorization**: The final step in the sign-in experience. Once the user has been authenticated and consented to the necessary actions, they will be redirected back to the client application with granted authorization.

## 4. Definitions

### 4.1 Interaction event

Interaction event represent the user's current interaction purpose with Logto. Logto will use the interaction event to track the user's interaction progress and provide the corresponding interaction validation and actions.

The following are the types of interaction event supported by Logto:

- **Register**: A new user signs up for a account in Logto.
- **SignIn**: An existing user signs in to their account.
- **ForgotPassword**: A user forgets their password and initiates an account recovery process.

### 4.2 Identifiers

The following are the types of `identifiers` supported by Logto that can be used to uniquely identify a user for the interaction:

- **Username**: A user's unique username.
- **Email**: A verified user's email address.
- **Phone**: A verified user's phone number.
- **Social identity**: A verified user identity data provided by a social identity provider.
- **SSO identity**: A verified user identity data provided by a enterprise SSO connector.

### 4.3 Verification record

A verification record contains the necessary security information to verify a user's identity. One or more verification records can be created and verified using the Experience APIs during the sign-in process.

#### 4.3.1. Primary verification

Primary verification can be used to verify the user's identity in a interaction with a given identifier. The following are the primary verification record types supported by Logto:

- **Password**: The user's password, which is the most common method for verifying identity. It can be used to verify the user's `username`, `email`, or `phone` identifier.
- **Verification code**: A one-time code sent to the user's email or phone number for identifier verification. It can be used to verify the user's `email` or `phone` identifier.
- **Social authentication**: An authenticated social identity used to directly identify and verify a user.
- **SSO authentication**: An authenticated SSO identity used to directly identify and verify a user.

#### 4.3.2. Multi-factor authentication(MFA) verification

MFA is a security process that requires more than one verification factor to confirm a user's identity. It can be used as an additional security check during user interaction. Developers can enable MFA using Logto's sign-in experience settings. Once enabled, users will be prompted to provide additional MFA verification records during the interaction. The following are the MFA verification record types supported by Logto:

- **TOTP code**: A time-based one-time code generated by a TOTP app for identity verification.
- **WebAuthn**: A WebAuthn credential used to verify a user's identity.
- **Backup code**: A set of backup codes used to verify a user's identity when other MFA verification methods are unavailable.

### 4.4 User profile

The user profile consists of the user data that will be stored in the Logto user database. Any new profile data provided by the user during the interaction will be saved to the database once the interaction is submitted. Developers can use Logto sign-in experience settings to define the required profile data and MFA settings for the user during the interaction.

#### 4.4.1 User identifier

The profile data can be used as unique identifiers for the user within the sign-in experience.

- **Username**: A unique username used to identify the user in the interaction.
- **Email**: Requires a verified `verification code` record for the email address in the interaction to claim the ownership of the email address.
- **Phone**: Requires a verified `verification code` record for the phone number in the interaction to claim the ownership of the phone number.
- **Social Identity**: Requires a authenticated `social authentication` record to verify the social identity in the interaction.
- **SSO Identity**: Requires a authenticated `SSO authentication` record to verify the SSO identity in the interaction.

#### 4.4.3 Password

The user's password, that can be used as a primary verification method to verify the user's identity during the interaction. The password can be set, updated, based on the user's interaction event.

- The `password` can be set during the `register` interaction event.
- The `password` can be set and updated during the `forgot-password` interaction event.
- The `password` can be set during the `sign-in` interaction event ONLY if the user has not set a password.

#### 4.4.3 MFAs settings

In order to enable MFA verification for the user, the user must provide the necessary MFA settings in Logto. The following MFA settings can be created and attached to the user's profile during the interaction:

- **TOTP secret**: A TOTP secret used to generate time-based one-time codes for MFA verification. A `TOTP code` verification record is required to verify the TOTP secret.
- **WebAuthn registration**: A WebAuthn credential used to verify a user's identity. A `WebAuthn` verification record is required to verify the WebAuthn registration.
- **Backup codes**: A set of backup codes used to verify a user's identity when other MFA verification methods are unavailable.

## 5. Interaction

Logto uses the interaction to track the user's progress and status during the sign-in experience. All the interaction data will be stored in the short-lived authentication session and submitted to Logto once the user completes the interaction.

### 5.1 Interaction schema

- **accountId**: The userId of the user for the current interaction. Only available once the user is identified by at least one verified identifier.
- **interactionEvent**: The interaction event for the current interaction.
- **verificationRecords**: The verification record list created during the current interaction.
- **profile**: The user provided profile data in the current interaction that needs to be updated in the user database.

### 5.2 Interaction status

In a sign-in experience, the user's interaction progress be tracked based on the sign-in experience settings and data provided by the user.

- **Initiated**: The interaction is initiated by the user.
- **Identified**: The user is identified by a verified identifier.
- **Verified**: The user is verified by all the necessary verification records, including the MFA.
- **ProfileFulfilled**: The user has provided all the necessary profile data and MFA settings.

#### 5.2.1 Sign-in event interaction status

Based on the user's sign-in experience progress and user provided data, Logto will track the sign-in interaction using the following status:

1. Initiated: The interaction is initiated by the user.

   - **accountId**: NULL. The user has not been identified yet.
   - **interactionEvent**: OPTIONAL. The interaction event may or may not be specified.
   - **verificationRecords**: OPTIONAL. Verification records may be created but not verified yet.
   - **profile**: NULL. The user can not provide profile data before they are identified and verified.

2. Identified: The user is identified by at least one verified identifier.

   - **accountId**: REQUIRED. The userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Sign-in interaction event has been specified.
   - **verificationRecords**: REQUIRED.
     - The identifier verification records are created and verified.
   - **profile**: NULL. The user can not provide profile data before they are verified.

3. Verified: The user is verified by all the necessary verification records, including the MFA.

   - **accountId**: REQUIRED. The userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Sign-in interaction event has been specified.
   - **verificationRecords**: REQUIRED.
     - The identifier verification records are created and verified.
     - All the necessary MFA verification records are created and verified.
   - **profile**: OPTIONAL. The user can provide profile data during the interaction after they are verified.

4. ProfileFulfilled: The user has provided all the necessary profile data and MFA settings during the interaction.

   - **accountId**: REQUIRED. The userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Sign-in interaction event has been specified.
   - **verificationRecords**: REQUIRED.
     - The identifier verification records are created and verified.
     - All necessary MFA verification records are created and verified.
     - Any newly added user identifiers in the profile have corresponding verification records created and verified.
     - Any newly added MFA settings in the profile have corresponding verification records created and verified.
   - **profile**: REQUIRED. The user has provided all the necessary profile data during the interaction.

5. Submitted: The user has submitted the interaction to Logto for authentication. The user profile and MFA settings will be updated in the user database. Continue to the consent and authorization process.

#### 5.2.2 Register event interaction status

Based on the user's sign-in experience progress and user provided data, Logto will track the register interaction using the following status:

1. Initiated: The interaction is initiated by the user.

   - **accountId**: NULL. No user account is created yet.
   - **interactionEvent**: OPTIONAL. The interaction event may or may not be specified.
   - **verificationRecords**: OPTIONAL. Verification records may be created but not verified yet.
   - **profile**: NULL. The user can not provide profile data before they are identified and verified.

2. Identified: The user has at least one necessary identifier provided that can uniquely identify the user.

   The user will be created in the user database once a verified identifier is provided.

   - **accountId**: REQUIRED. The new userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Register interaction event has been specified.
   - **verificationRecords**: OPTIONAL.
     - REQUIRED if the user has provided a verified identifier. The identifier verification records are created and verified.
     - NULL if username is used as the identifier.
   - **profile**: REQUIRED. The user have provided the necessary sign-up identifier.

3. Verified: A `Identified` register interaction status is also `Verified` as the new user does not have any existing MFA settings.

4. ProfileFulfilled: The user has provided all the necessary profile data and MFA settings during the interaction.

   - **accountId**: REQUIRED. The new userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Register interaction event has been specified.
   - **verificationRecords**: OPTIONAL.
     - REQUIRED if the user has provided a verified identifier. The identifier verification records are created and verified.
     - REQUIRED Any newly added MFA settings in the profile have corresponding verification records created and verified.
   - **profile**: REQUIRED. The user has provided all the necessary profile data and MFA settings during the interaction.

5. Submitted: The user has submitted the interaction to Logto for authentication. The user profile and MFA settings will be updated in the user database. Continue to the consent and authorization process.

#### 5.2.3 Forgot password event interaction status

- Only `email` and `phone` identifiers can be used to identify the user for the forgot password interaction in Logto.
- The user must provide a valid `verification code` verification record to verify the identifier during the interaction.
- All other types of identifiers and verification records are ignored during the forgot password interaction.
- Only `password` can be set in the user's profile during the forgot password interaction.
- The forgot password interaction does not require any MFA verification, so the interaction status will never be `Verified`.

1. Initiated: The interaction is initiated by the user.

   - **accountId**: NULL. Not available for the forgot password interaction.
   - **interactionEvent**: OPTIONAL. The interaction event may or may not be specified.
   - **verificationRecords**: OPTIONAL. Verification records may be created before the user is identified.
   - **profile**: NULL. The user can not provide profile data before they are identified and verified.

2. Identified: The user is identified by at least one verified identifier email or phone.

   - **accountId**: REQUIRED. The userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Forgot password interaction event has been specified.
   - **verificationRecords**: REQUIRED. The identifier verification records are created and verified.
   - **profile**: NULL. The user can not provide profile data before they are verified.

3. ProfileFulfilled: The user has the new password provided.

   - **accountId**: REQUIRED. The userId of the user for the current interaction.
   - **interactionEvent**: REQUIRED. Forgot password interaction event has been specified.
   - **verificationRecords**: REQUIRED. The identifier verification records are created and verified.
   - **profile**: REQUIRED. The password has been set during the interaction.

4. Submitted: The user has submitted the interaction to Logto for authentication. The user's password will be updated in the user database. Interaction will be completed.

## 6. Drawbacks

### 6.1 Compatibility

Unlike the current internal interaction APIs, the new experience APIs are publicly available to the developers, as they can be used to build a customized sign-in experience. This mains any changes to the experience APIs may impact the existing developers who rely on the APIs to build their sign-in experience. We need to ensure backward compatibility and carefully version the experience APIs to avoid breaking changes for the developers.

### 6.2 Complexity

The new experience API is stateful and tightly coupled with the sign-in interaction on the Logto server side. Developers must fully understand the concept of interactions in Logto and the related sign-in experience settings to use the experience APIs correctly. This requirement can increase the learning curve and development complexity, potentially leading to misuse or integration errors if not properly understood and implemented.

### 6.3 Cost

Introducing new set of experience APIs will require additional development effort and maintenance cost. Instead of our current internal interaction APIs, the new experience APIs need to be well-documented and maintained to ensure a consistent and reliable sign-in experience for the developers.

We will need to keep two sets of APIs in sync to ensure that the experience APIs are up-to-date with the internal interaction APIs. This will require additional development and testing effort to maintain the consistency between the two sets of APIs.

### 6.4 Performance overhead

To maintain interaction status and decouple API logic, multiple API requests are required from the client side. For example, an additional /api/experience/submit request must be called each time to submit and validate interaction requirements, even for a simple username and password sign-in flow. Instead of a single /api/experience/sign-in request, an extra /submit request is necessary. This increases the number of API calls, potentially leading to higher latency and reduced performance.

## 7. Rationale and alternatives

Logto provides a variety of authentication and verification methods to meet the diverse needs of developers and end-users. We have been constantly improving the sign-in experience configurations and providing extra customization options for the developers to build a flexible and secure sign-in experience. As the sign-in experience is a critical part of the user authentication process, and it is hard to enumerate all the possible uses cases and customization requirements, we believe that opening up the experience APIs to the developers with a customizable front-end user interface will provide more flexibility and control over the sign-in experience.

### 7.1 Considerations

1. Developer Friendly: The current internal interaction APIs are not well-documented and are difficult for developers to use. These APIs are tightly coupled with Logto's server-side interaction logic and involve numerous Logto-specific concepts and definitions, resulting in a steep learning curve. We believe that providing a new set of well-documented and user-friendly experience APIs will significantly ease the development process for creating customized sign-in experiences. Additionally, we need to offer a detailed explanation of the underlying user interaction structure to help developers better understand the sign-in experience.

2. High flexibility: We have identified several limitations in the current internal interaction APIs, such as the lack of support for custom user profile fields and the increasingly bloated interaction structure within the Logto server. By introducing the new experience API, we can redefine the interaction in Logto, enhancing the flexibility and sustainability of the sign-in experience.

### 7.2 Alternatives

Considering no extra new features or customization options are added, instead of introducing a new set of experience APIs, we could consider providing comprehensive documentation for the existing internal interaction APIs. This approach would minimize the risk of breaking changes to the sign-in experience. However, even with detailed documentation, developers may still find it challenging to understand and effectively use these internal interaction APIs.

Moreover, continuing to use our existing APIs and interaction design will likely lead to a rapidly increasing maintenance effort as we keep introducing new features and flows to our system. Eventually, we will reach a point where refactoring and migrating our existing sign-in experience logic will be unavoidable. Therefore, the best time to implement these changes is now.

## 8.Future possibilities

### 8.1.User profile management

The verification and user profile APIs can be extended to support more advanced user profile management features, outside the sign-in experience. For example, users can update their profile data, manage their MFA settings, and view their interaction history using the experience APIs through a dedicated user profile management interface.

### 8.2 Simplified experience API calls

Reduce the complexity of the experience API calls. We are considering merging several API calls into a single API call to simplify the user interaction flow. For example, omit the extra `/submit` request for the sign-in experience, consider introducing a `autoSubmit` flag in some of the interaction APIs to automatically submit the interaction once all the requirements are met.

### 8.3 Provide additional custom user profiles in a sign-in experience

The user profile data can be extended to support custom user profile fields in the sign-in experience. Developers can define and set required custom profile fields for the user during the interaction. This will allow developers to collect additional user data and customize the user profile based on their specific use cases.

### 8.4 Experience API SDK

Develop a client-side SDK that simplifies the integration of the experience APIs into the front-end application. The SDK can provide a set of pre-built components and functions that handle the interaction flow, user profile management, and MFA settings. This will help developers quickly integrate the experience APIs into their applications and build a customized sign-in experience with minimal effort.

### 8.5 Additional password and social/SSO verification APIs

Currently the password verification record was created directly in the sign-in authentication API. We can consider providing additional verification APIs to create and verify the password verification record separately. This will allow developers to customize the password verification process and create a password verification record outside the sign-in experience.
Currently the social and SSO verification record was created using the social/SSO authentication API. We can consider providing additional verification APIs to create and verify the social/SSO verification record separately. This will allow developers to customize the social/SSO authentication process and create a social/SSO verification record outside the sign-in experience.

### 8.6 Open verification APIs

The verification APIs as well as the verification record can be extended to support other verification circumstances outside the sign-in experience. For example, support dynamic MFA verification.

## Appendix A. Experience API

The experience API are a set of APIs that allow end-users to interact with the Logto to complete the user sign-in experience.

```ts
type Identifier = {
  type: "username" | "email" | "phone";
  value: string;
};
```

### 1. Interaction authentication API

The interaction authentication API is the core set of APIs to identify the user during the sign-in experience.
A successful interaction authentication will change the interaction status from `Initiated` to `Identified`.

- **Specify interaction event type**: Define the type of interaction event to be initiated.
- **Provide necessary identifiers**: The user must provide the necessary identifiers to identify themselves in the interaction.
- **Provide necessary verification records**: The user must provide the necessary verification records to verify their identity in the interaction.

#### Sign in

- `POST /api/experience/auth/sign-in/password`

  Identify the user with the given `identifier` and a password verification record.

  - A `SignIn` interaction event will be initiated for the interaction.
  - A password verification record will be created in the interaction.
  - The `accountId` will be set to the user's `userId` if the user is identified successfully.
  - The interaction status will be changed to `Identified` if the user is identified successfully.

  Request body:

  | Field      | Type       | Description              | Required |
  | ---------- | ---------- | ------------------------ | -------- |
  | identifier | Identifier | The user's `identifier`. | Yes      |
  | password   | String     | The user's password.     | Yes      |

- `POST /api/experience/auth/sign-in/verification-code`

  Identify the user with the given `identifier` and a verification record.

  - A `SignIn` interaction event will be initiated for the interaction.
  - A `verificationId` pointing to a verified verification record should be provided if a `email` or `phone` identifier is used to identify the user.
  - If no `verificationId` is provided, a new verification code record will be created in the interaction, and a code will be sent to the given `identifier`.
  - The `accountId` will be set to the user's `userId` if a verified verification record is found and the user is identified successfully.
  - The interaction status will be changed to `Identified` if a verified verification record is found and the user is identified successfully.

  Request body:

  | Field          | Type       | Description                                | Required |
  | -------------- | ---------- | ------------------------------------------ | -------- |
  | identifier     | Identifier | The user's `identifier`.                   | Yes      |
  | verificationId | string     | The unique id for the verification record. | No       |

- `POST /api/experience/auth/sign-in/verification-code/verify`

  The concurrent API to verify the given `identifier` with the provided verification code.

  - The verification record will be verified in the interaction.
  - The `accountId` will be set to the user's `userId` if the verification is successful.
  - The interaction status will be changed to `Identified` if the verification is successful.

  Request body:

  | Field          | Type       | Description                                           | Required |
  | -------------- | ---------- | ----------------------------------------------------- | -------- |
  | identifier     | Identifier | The user's `identifier`.                              | Yes      |
  | code           | string     | The verification code to verify the given identifier. | Yes      |
  | verificationId | string     | The unique id for the verification record.            | Yes      |

#### Register

- `POST /api/experience/auth/register`

  The `register` API is used to create a new account in Logto. The user must provide at least one `identifier` to uniquely identify themselves in Logto.

  - A `Register` interaction event will be initiated for the interaction.
  - A password must be provided if the user is creating a new account with a `username` identifier.
  - A `verificationId` pointing to a verified verification record should be provided if a `email` or `phone` identifier is used to identify the user.
  - If the user provides a `email` or `phone` identifier without a verificationId, A new verification code record will be created, and a code will be sent to the given `identifier`.
  - A new user account will be created in Logto if the required identifier are provided and verified.
  - The `accountId` will be set to the new user's `userId` if the user is created successfully.
  - The interaction status will be changed to `Verified` if the user is created successfully. As the new user does not have any existing MFA settings.

  Request body:

  | Field          | Type       | Description                                | Required |
  | -------------- | ---------- | ------------------------------------------ | -------- |
  | identifier     | Identifier | The user's `identifier`.                   | Yes      |
  | password       | string     | The user's password.                       | No       |
  | verificationId | string     | The unique id for the verification record. | No       |

- `POST /api/experience/auth/register/verification-code/verify`

  The concurrent API to verify the given `identifier` with the provided verification code during the register interaction.

  - The verification record will be verified in the interaction.
  - A new user account will be created in Logto if the required identifier are provided and verified.
  - The `accountId` will be set to the new user's `userId` if the user is created successfully.
  - The interaction status will be changed to `Verified` if the user is created successfully. As the new user does not have any existing MFA settings.

  Request body:

  | Field          | Type       | Description                                           | Required |
  | -------------- | ---------- | ----------------------------------------------------- | -------- |
  | identifier     | Identifier | The user's `identifier`.                              | Yes      |
  | code           | string     | The verification code to verify the given identifier. | Yes      |
  | verificationId | string     | The unique id for the verification record.            | Yes      |

#### Forgot password

- `POST /api/experience/forgot-password`

  The `forgot-password` API is used to initiate an account recovery process in Logto. The user must provide a valid `identifier` to start the account recovery process.

  - A `ForgotPassword` interaction event will be initiated for the interaction.
  - Only `email` and `phone` identifiers can be used to identify the user for the forgot password interaction in Logto.
  - A `verificationId` pointing to a verified verification record should be provided.
  - If no `verificationId` is provided,, a new verification code record will be created, and a code will be sent for the given `identifier`.
  - The interaction status will be changed to `Identified` if the user is identified successfully.

  Request body:

  | Field          | Type       | Description                                | Required |
  | -------------- | ---------- | ------------------------------------------ | -------- |
  | identifier     | Identifier | The user's `identifier`.                   | Yes      |
  | verificationId | string     | The unique id for the verification record. | No       |

- `POST /api/experience/forgot-password/verification-code/verify`

  The concurrent API to verify the given `identifier` with the provided verification code during the forgot password interaction.

  - The verification record will be verified in the interaction.
  - The interaction status will be changed to `Identified` if the verification is successful.

  Request body:

  | Field          | Type       | Description                                           | Required |
  | -------------- | ---------- | ----------------------------------------------------- | -------- |
  | identifier     | Identifier | The user's `identifier`.                              | Yes      |
  | code           | string     | The verification code to verify the given identifier. | Yes      |
  | verificationId | string     | The unique id for the verification record.            | Yes      |

### 2. Social/SSO authentication API

The social/SSO authentication API is used to authenticate the user with a third-party social or enterprise identity provider.
A successful social/SSO authentication will change the interaction status from `Initiated` to `Identified`.

- `POST /api/experience/auth/{social|sso}/:connectorId/authorization-url`

  Generate an authorization URL for the user to authenticate with a third-party social or enterprise identity provider.

  - A `SignIn` interaction event will be initiated for the interaction.
  - A social/SSO verification record will be created in the interaction.

- `POST /api/experience/auth/{social|sso}/:connectorId/authenticate`

  Authenticate the user with the social/SSO provider and identify the user with the authenticated social/SSO identity.

  - The social/SSO verification record will be verified in the interaction.
  - The `accountId` will be set to the user's `userId` if the verification is successful and a user is identified.
  - The interaction status will be changed to `Identified` if the verification is successful and a user is identified.
  - For SSO authentication, if the SSO identity is not found in Logto database, but the verified email is found, the SSO identity will be added to the user profile in the interaction and the user will be identified.

  Request body:

  | Field | Type                   | Description                                |
  | ----- | ---------------------- | ------------------------------------------ |
  | data  | Record<string, string> | callback data from the social/SSO provider |

- `POST /api/experience/{social|sso}/:connectorId/register`

  The concurrent API to register a new user with the provided social/SSO identity. If the social/SSO identity is not found in Logto.

  - The interaction event will be changed to `Register`.
  - A new user account will be created in Logto with the provided social/SSO identity.
  - The `accountId` will be set to the new user's `userId` if the user is created successfully.
  - The interaction status will be changed to `Verified` if the user is created successfully. As the new user does not have any existing MFA settings.

- `POST /api/experience/social/:connectorId/link`

  The concurrent API to link the existing user account with the provided social identity.
  Unlike SSO authentication, if the social identity is not found in Logto, but the verified email is found, the social identity need to be manually linked to the existing account via this API.

  - The `accountId` will be set to the user's `userId` identified by the verified email.
  - The interaction status will be changed to `Identified` if the verification is successful and a user is identified.
  - The social identity will be added to the user profile in the interaction.

### 3. Verification API

The verification API is a set of APIs used to create and verify a verification record for the user during the sign-in experience.

- Verification API can be used at any time to create and verify the necessary verification records for the user during the interaction.
- Once the verification record is created, a unique `verification id` will be generated for tracking the verification process.

#### Verification code

- `POST /api/experience/verification/verification-code`
  Send a verification code to the user's email or phone number for identifier verification.

  - A verification code record will be created in the interaction.
  - The unique `verificationId` will be generated for the verification record.
  - A code will be sent to the given `identifier`.
  - The interaction event is required to specify the message template for the verification code.

  Request body:

  | Field            | Type             | Description                                                     | Required |
  | ---------------- | ---------------- | --------------------------------------------------------------- | -------- |
  | identifier       | Identifier       | The user's `identifier`.                                        | Yes      |
  | interactionEvent | InteractionEvent | The `interaction event` that triggers the verification process. | Yes      |

- `POST /api/experience/verification/verification-code/verify`

  The concurrent API to verify the given `identifier` with the provided verification code.

  - The verification record will be verified in the interaction, if the code is verified successfully.

  Request body:

  | Field          | Type       | Description                                           | Required |
  | -------------- | ---------- | ----------------------------------------------------- | -------- |
  | identifier     | Identifier | The user's `identifier`.                              | Yes      |
  | code           | string     | The verification code to verify the given identifier. | Yes      |
  | verificationId | string     | The unique id for the verification record.            | Yes      |

#### TOTP

- `POST /api/experience/verification/totp/secret`

  Create a new TOTP secret for the user to set up the TOTP MFA method.

  - A new TOTP secret will be generated for the user.
  - A new TOTP verification record will be created in the interaction.

- `POST /api/experience/verification/totp/verify`

  TOTP code verification API.

  - For the first time verification of a new added TOTP secret, the `verificationId` is required.
  - For the first time verification of a new added TOTP secret, the verification record will be verified.
  - For the first time verification of a new added TOTP secret, the new TOTP secret will be inserted into the user profile in the interaction as a new MFA setting.
  - For the existing TOTP secret verification, the `verificationId` empty.
  - For the existing TOTP secret verification, a verified TOTP verification record will be created.

  Request body:

  | Field           | Type   | Description                                      | Required |
  | --------------- | ------ | ------------------------------------------------ | -------- |
  | code            | string | The TOTP code to verify the TOTP MFA method      | Yes      |
  | verificationId? | string | The verification id for the new generated secret | No       |

#### WebAuthn

- `POST /api/experience/verification/webAuthn/registration`

  Create a new WebAuthn registration options object for the user to verify and set up the WebAuthn MFA method.

  - A new WebAuthn registration options object will be generated for the user.
  - A new WebAuthn verification record will be created in the interaction with the generated WebAuthn registration options.

- `POST /api/experience/verification/webAuthn/authentication`

  Create a new WebAuthn authentication options object for the user to verify the WebAuthn MFA method.

  - A new WebAuthn authentication options object will be generated for the user.
  - A new WebAuthn verification record will be created in the interaction with the generated WebAuthn authentication options.

- `POST /api/experience/verification/webAuthn/verify`

  The concurrent API to verify the WebAuthn MFA method with the provided WebAuthn assertion.

  - The WebAuthn assertion data will be verified with the WebAuthn verification record in the interaction.
  - The WebAuthn verification record will be verified if the assertion is successful.
  - A new WebAuthn credential will be inserted into the user profile in the interaction as a new MFA setting if the verification record is for a new WebAuthn registration.

  Request body:

  | Field             | Type              | Description                                                   | Required |
  | ----------------- | ----------------- | ------------------------------------------------------------- | -------- |
  | webAuthnAssertion | WebAuthnAssertion | The WebAuthn assertion data to verify the WebAuthn MFA method | Yes      |
  | verificationId    | string            | The verification record id                                    | Yes      |

#### Backup codes

- `POST /api/experience/verification/backup-codes/generate`

  Generate a new set of backup codes for the user to set up the Backup Code MFA method.

  - A new set of backup codes will be generated for the user.
  - The backup codes will be inserted into the user profile in the interaction as a new MFA setting.

- `POST /api/experience/verification/backup-code/verify`

  Verify the Backup Code MFA method with the provided backup code.

  - A verified backup code verification record will be created in the interaction if the backup code is verified successfully.

  Request body:

  | Field      | Type   | Description                                   | Required |
  | ---------- | ------ | --------------------------------------------- | -------- |
  | backupCode | string | the backup code to verify the Backup Code MFA | Yes      |

### 4. Profile fulfillment API

The profile fulfillment API is used to provide additional profile data and MFA settings during the sign-in experience. Upon the sign-in experience settings, the user must provide the necessary profile data and MFA settings to complete the interaction.

- Profile fulfillment API can be used only if the current interaction is `Identified` and `Verified`.
- Password can be set using the profile fulfillment API during the `forgot-password` interaction event if the current interaction is `Identified`.

- `PATCH /api/experience/profile`

  The `profile` API is used to update the user's profile information in Logto.

  - A verification record is required to verify the given identifier if the `email`, or `phone` is provided in the profile data.

  Request body:

  | Field    | Type                         | Description                                              | Required                     |
  | -------- | ---------------------------- | -------------------------------------------------------- | ---------------------------- |
  | email    | IdentifierWithVerificationId | The user's email address with a verified verification Id | No                           |
  | phone    | IdentifierWithVerificationId | The user's phone number with a verified verification Id  | No                           |
  | username | string                       | The user's username.                                     | No                           |
  | password | string                       | The user's password.                                     | No (Yes for password update) |

  Additional profile data can be added based on the sign-in experience settings.

- `POST /api/experience/profile/mfa-skipped`

  The `mfa-skipped` API is used to skip the MFA setup process for the user.

  - The user can skip the MFA setup process if the MFA settings are optional in the sign-in experience settings.
  - The MFA settings check will be skipped during the profile fulfillment status validation of the interaction.

### 5. Interaction status API

- `POST /api/experience/submit`

  The `submit` API is used to submit the user's interaction to the Logto.

  - All the precondition checks will be performed before submitting the interaction. The interaction will be rejected if any of the checks fail.
  - The interaction must be `Identified`, `Verified`, and `ProfileFulfilled` to be submitted successfully.
  - Once the interaction is submitted, the new user profile and MFA settings will be updated in the user database.

- `GET /api/experience/interaction-status`

  The `interaction-status` API is used to get the current status of the user's interaction. The user can use this API to check the progress and missing requirements of the interaction.

  - **interactionEvent**: The interaction event for the current interaction.
  - **accountId**: The userId of the user for the current interaction. Only available once the user is identified by at least one verified identifier.
  - **verificationRecordStatus**: The verification record list created during the current interaction. Only verification type, status, and verificationId are returned.
  - **profileKeys**: The user provided profile keys in the current interaction that will be updated in the user database.
  - **status**: The current status of the interaction.

## Appendix B. Examples
